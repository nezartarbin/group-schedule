<!DOCTYPE html>
<html>
    <head>
        <title>Schedule App</title> 
        <!--Importing Google Font-->
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
        <!--Importing local CSS stylesheet-->
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <!--importing Axios JS for HTTP requests-->
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script>
            var availability = {};

            function isEmpty(obj) {
                for(var key in obj) {
                    if(obj.hasOwnProperty(key))
                        return false;
                }
                return true;
            }


            function timeOffset(days) {
                scheduleTime = new Date(scheduleTime.getFullYear(), scheduleTime.getMonth(), (scheduleTime.getDate() + days));
            };

            function clickDiv() {
                let daydiv = document.querySelectorAll(".schedule-label")[this.weekDay].time;
                if (this.state.clicked == false) {
                    let d = new Date(daydiv.getFullYear(),daydiv.getMonth(),daydiv.getDate(),this.hour);
                    if (availability.hasOwnProperty(daydiv.getDate()) == false) {availability[daydiv.getDate()] = {}};
                    availability[daydiv.getDate()][this.hour] = d;
                    this.state.clicked = true;
                    this.className = "schedule-cell-clicked";
                }
                else {
                    delete availability[daydiv.getDate()][this.hour];
                    if (isEmpty(availability[daydiv.getDate()]) == true) {delete availability[daydiv.getDate()]};
                    this.state.clicked = false;
                    this.className = "schedule-cell";
                }
                console.log(availability);
            }

            function postSchedule() {
                let submission = {
                    id: document.querySelector("#id").value,
                    user: document.querySelector("#username").value,
                    time: []
                };
                for (day in availability) {
                    for (hour in availability[day]) {
                        console.log(availability[day][hour]);
                        submission.time.push(availability[day][hour]);
                    }
                }
                console.log(submission);

                axios.post('/user', submission)
                .then((res) => {
                    console.log(response);
                }).catch((err) => {
                    console.log(err);
                })
            }
         </script>
    </head>

    <body>
        <h1> Group Schedule </h1>
        <!--schedule-div is a grid container, or wrapper-->
        <p id="time"></p>
        <div id="buttons">
            <button class="time" onclick="timeOffset(-7); timeConfig();" >&#8249;</button>
            <button class ="time" onclick="scheduleTime = currentTime; availability = {}; timeConfig();">Reset</button>
            <button class="time" onclick="timeOffset(7); timeConfig();">&#8250;</button>
        </div>
        <div id="labels"></div>
        <div id="schedule-div">
            <!--We need to create a grid (table) of time slots.
            we could make every div individually, but this is not
            a good idea. Too many divs. we use Javascript.-->

            <!--Our grid needs to consist of one row with every day
            of the week in it, and then 24 rows of each hour of the day.
            Each slot needs to have the hour of the day written on it.-->

        </div>

        <script>
                const currentTime = new Date();
                var scheduleTime = currentTime;

                const dayName = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul","Aug", "Sep", "Oct", "Nov", "Dec"];

                function scheduleGenerate() {

                    for (weekday=0; weekday<7; weekday++) {
                        var labelDiv = document.createElement("div");
                        labelDiv.className= "schedule-label";
                        document.querySelector("#labels").appendChild(labelDiv);
                    }

                    for (weekday=0; weekday<7;weekday++){
                        for (i=0; i < 24; i++) {
                            var childDiv = document.createElement("div");
                            //childDiv.clickstate = false;

                            //childDiv.time = new Date(scheduleTime.getFullYear(), scheduleTime.getMonth(), monthDate, hour);
                            childDiv.hour = i;
                            childDiv.className = "schedule-cell";

                            let ampm = i >= 12 ? " PM" : " AM";
                            let hour = i%12;
                            hour = hour ? hour : 12;
                            childDiv.textContent = hour + ampm;
                            childDiv.weekDay = weekday;
                            childDiv.state = {clicked: false};

                            document.querySelector("#schedule-div").appendChild(childDiv);

                            
                        }
                    }
                }

                function timeConfig() {
                    let weekday = 0;
                    let labelDivs = document.querySelector("#labels").childNodes;
                    labelDivs.forEach((div) => {
                        let monthDate = scheduleTime.getDate() + (weekday - scheduleTime.getDay());
                        div.time = new Date(scheduleTime.getFullYear(), scheduleTime.getMonth(), monthDate);

                        div.innerHTML = dayName[weekday] + "<br>" + monthNames[div.time.getMonth()] + " " + div.time.getDate();
                        weekday++;
                    })

                    Array.from(document.querySelector("#schedule-div").children).forEach((div) => {
                        let time = labelDivs[div.weekDay].time;
                        if (availability.hasOwnProperty(time.getDate())) {
                            if (availability[time.getDate()].hasOwnProperty(div.hour)) {
                                div.state.clicked = true;
                                div.className = "schedule-cell-clicked";
                            }
                        }
                        else {
                            div.state.clicked = false;
                            div.className = "schedule-cell";
                        }
                    })
                }

                scheduleGenerate();
                timeConfig();

                var cells = document.querySelectorAll(".schedule-cell");
                cells.forEach((div) => {div.addEventListener("click",clickDiv)});
            
            </script>

        <!--submit button. When clicked, it will call function "poststuff() which is defined in head-->
        <div id="formone">
            username: <input type="text" id="username">
            ID: <input type="text" id="id">
            <button id="submit-time" onclick="postSchedule()">Submit</button>
        </div>
    </body>
</html>